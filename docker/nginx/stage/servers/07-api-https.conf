# API Server HTTPS
server {
    listen 443 ssl;
    server_name api.squidweb.ir;
    
    include config/ssl.conf;
    
    # Rate limiting
    limit_req zone=one burst=20 nodelay;
    limit_conn addr 100;
    
    # Performance settings
    expires 1h;
    more_set_headers "Cache-Control: public, no-transform";
    
    # First handle the OPTIONS preflight requests
    if ($request_method = 'OPTIONS') {
        return 204;
    }
    
    # JWT and CORS
    access_by_lua_file conf/config/jwt_verification.lua;
    include config/cors_headers.conf;
    
    # Health check endpoint
    location = /health {
        access_log off;
        return 200 'healthy\n';
    }
    
    # Service links
    location = / {
        default_type text/html;
        content_by_lua_file conf/config/service_links.lua;
    }
    
    # API Routes with rate limiting
    location /Blog/ {
        limit_req zone=one burst=10 nodelay;
        proxy_pass http://blog_api;
        include config/proxy_headers.conf;
    }
    
    location /Order/ {
        limit_req zone=one burst=10 nodelay;
        proxy_pass http://order_api;
        include config/proxy_headers.conf;
    }
    
    location /Payment/ {
        limit_req zone=one burst=10 nodelay;
        proxy_pass http://payment_api;
        include config/proxy_headers.conf;
    }
    
    location /Product/ {
        limit_req zone=one burst=10 nodelay;
        proxy_pass http://product_api;
        include config/proxy_headers.conf;
    }
    
    location /Search/ {
        limit_req zone=one burst=10 nodelay;
        proxy_pass http://search_api;
        include config/proxy_headers.conf;
    }
    
    location /Site/ {
        limit_req zone=one burst=10 nodelay;
        proxy_pass http://site_api;
        include config/proxy_headers.conf;
    }
    
    location /User/ {
        limit_req zone=one burst=10 nodelay;
        proxy_pass http://user_api;
        include config/proxy_headers.conf;
    }
    
    location /Drive/ {
        limit_req zone=one burst=10 nodelay;
        proxy_pass http://drive_api;
        include config/proxy_headers.conf;
    }
    
    location /Ai/ {
        limit_req zone=one burst=10 nodelay;
        proxy_pass http://ai_api;
        include config/proxy_headers.conf;
    }
    
    location /Support/ {
        limit_req zone=one burst=10 nodelay;
        proxy_pass http://support_api;
        include config/proxy_headers.conf;
    }
    
    # Deny access to sensitive files
    location ~ /\.(ht|git|svn) {
        deny all;
        return 404;
    }
} 